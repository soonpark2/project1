<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>소득조사 대시보드</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Malgun Gothic', 'Segoe UI', sans-serif;
            background: #f8f9fa;
            font-size: 12px;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
            color: white;
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            border-bottom: 2px solid #1e40af;
        }
        
        .header-left {
            font-weight: bold;
        }
        
        .header-right {
            display: flex;
            gap: 20px;
        }
        
        .container {
            display: flex;
            height: calc(100vh - 50px);
        }
        
        .sidebar {
            width: 250px;
            background: #ffffff;
            border-right: 1px solid #e5e7eb;
            padding: 15px;
            overflow-y: auto;
        }
        
        .main-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .filter-section {
            margin-bottom: 20px;
        }
        
        .filter-title {
            background: #3b82f6;
            color: white;
            padding: 8px 12px;
            font-weight: bold;
            font-size: 13px;
            border-radius: 4px 4px 0 0;
        }
        
        .filter-content {
            border: 1px solid #e5e7eb;
            border-top: none;
            background: white;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .filter-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            font-size: 12px;
            transition: background 0.2s;
        }
        
        .filter-item:hover {
            background: #f3f4f6;
        }
        
        .filter-item.active {
            background: #dbeafe;
            color: #1e40af;
            font-weight: bold;
        }
        
        .year-buttons {
            background: white;
            border: 1px solid #e5e7eb;
            border-top: none;
        }
        
        .year-btn {
            padding: 8px 12px;
            border: none;
            border-bottom: 1px solid #f3f4f6;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
            width: 100%;
            text-align: left;
        }
        
        .year-btn:hover {
            background: #f3f4f6;
        }
        
        .year-btn.active {
            background: #dbeafe;
            color: #1e40af;
            font-weight: bold;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto;
            gap: 15px;
            height: 100%;
        }
        
        .chart-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-size: 14px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .combined-section {
            grid-column: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .income-summary {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .summary-box {
            flex: 1;
            text-align: center;
            padding: 20px;
            border-radius: 8px;
        }
        
        .summary-box.income {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border: 2px solid #3b82f6;
        }
        
        .summary-box.rate {
            background: linear-gradient(135deg, #fef3c7, #fed7aa);
            border: 2px solid #f59e0b;
        }
        
        .summary-value {
            font-size: 28px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 5px;
        }
        
        .summary-label {
            font-size: 14px;
            color: #6b7280;
        }
        
        .table-wrapper {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            flex: 1;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        th {
            background: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
            padding: 10px 8px;
            text-align: left;
            font-weight: bold;
            color: #374151;
            position: sticky;
            top: 0;
        }
        
        td {
            padding: 8px;
            border-bottom: 1px solid #f3f4f6;
            color: #1f2937;
        }
        
        tr:hover {
            background: #f9fafb;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #6b7280;
        }
        
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .combined-section {
                grid-column: 1;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
            }
            
            .income-summary {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">소득조사 대시보드</div>
        <div class="header-right">
            <span>현황</span>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="filter-section">
                <div class="filter-title">지역구분</div>
                <div class="filter-content" id="regionFilter">
                    <div class="filter-item active" data-region="전국">전국</div>
                    <div class="filter-item" data-region="강원">강원</div>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-title">작목</div>
                <div class="filter-content" id="cropGroupFilter">
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-title">작목상세</div>
                <div class="filter-content" id="cropFilter">
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-title">년</div>
                <div class="year-buttons" id="yearFilter">
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="charts-grid">
                <div class="chart-card combined-section">
                    <div class="chart-title" id="summaryTitle">2023년 전국 소득분석표</div>
                    <div class="income-summary">
                        <div class="summary-box income">
                            <div class="summary-label">소득</div>
                            <div class="summary-value" id="totalIncome">₩0</div>
                            <div class="summary-label">총수량</div>
                        </div>
                        <div class="summary-box rate">
                            <div class="summary-label">소득률</div>
                            <div class="summary-value" id="totalRate">0%</div>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>비목</th>
                                    <th>값</th>
                                </tr>
                            </thead>
                            <tbody id="detailTableBody">
                                <tr><td colspan="2" class="loading">데이터를 불러오는 중...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-title">총수입</div>
                    <div class="chart-container">
                        <canvas id="incomeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let csvData = [];
        let filteredData = [];
        let currentFilters = {
            region: '전국',
            cropGroup: '',
            crop: '',
            year: '2023'
        };
        let charts = {};

        // GitHub에서 CSV 파일 불러오기
        async function loadCSVFromGitHub() {
            try {
                const csvUrl = 'https://raw.githubusercontent.com/soonpark2/project1/main/DB.csv';
                const response = await fetch(csvUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                parseCSV(csvText);
            } catch (error) {
                console.error('CSV 파일 로드 오류:', error);
                showError(`GitHub에서 CSV 파일을 불러올 수 없습니다: ${error.message}`);
                loadTestData();
            }
        }

        // 테스트 데이터 (백업용)
        function loadTestData() {
            const testData = `지역구분,년,작목군,작목,구분,값
전국,2023,쌀,쌀,소득,5000000
전국,2023,쌀,쌀,소득률,18.8
전국,2023,쌀,쌀,비목,주산물가액
전국,2023,쌀,쌀,비목,주산물수량
전국,2023,쌀,쌀,비목,부산물가액
전국,2023,쌀,쌀,비목,수취가격
전국,2023,쌀,쌀,비목,종자·종묘비
전국,2023,쌀,쌀,비목,비료비
전국,2023,쌀,쌀,비목,농약비
전국,2023,쌀,쌀,비목,광열동력비
전국,2023,과일,사과,소득,4500000
전국,2023,과일,사과,소득률,17.2
전국,2023,과일,사과,비목,주산물가액
전국,2023,과일,사과,비목,종자·종묘비
전국,2023,과일,사과,비목,비료비
전국,2023,과일,사과,비목,농약비
전국,2023,과일,배,소득,4000000
전국,2023,과일,배,소득률,15.3
전국,2023,과일,배,비목,주산물가액
전국,2023,과일,배,비목,주산물수량
전국,2023,과일,배,비목,종자·종묘비
전국,2023,과일,배,비목,비료비
전국,2023,채소,배추,소득,3000000
전국,2023,채소,배추,소득률,12.5
전국,2023,채소,배추,비목,주산물가액
전국,2023,채소,배추,비목,주산물수량
전국,2023,채소,배추,비목,종자·종묘비
전국,2023,채소,배추,비목,비료비
전국,2023,채소,감자,소득,2500000
전국,2023,채소,감자,소득률,19.8
전국,2023,채소,감자,비목,주산물가액
전국,2023,채소,감자,비목,수취가격
전국,2023,채소,감자,비목,종자·종묘비
전국,2023,채소,감자,비목,농약비
강원,2023,과일,사과,소득,1000000
강원,2023,과일,사과,소득률,16.5
강원,2023,과일,사과,비목,주산물가액
강원,2023,과일,사과,비목,종자·종묘비
강원,2023,채소,감자,소득,2500000
강원,2023,채소,감자,소득률,19.8
강원,2023,채소,감자,비목,주산물가액
강원,2023,채소,감자,비목,종자·종묘비
강원,2023,채소,감자,비목,비료비`;
            
            parseCSV(testData);
        }

        function showError(message) {
            const tableBody = document.getElementById('detailTableBody');
            tableBody.innerHTML = `<tr><td colspan="2" style="text-align: center; color: #ef4444;">${message}</td></tr>`;
        }

        function parseCSV(csvText) {
            Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    csvData = results.data.map(row => ({
                        region: (row['지역구분'] || '').trim(),
                        year: (row['년'] || '').trim(),
                        cropGroup: (row['작목군'] || '').trim(),
                        crop: (row['작목'] || '').trim(),
                        category: (row['구분'] || '').trim(),
                        value: parseFloat((row['값'] || '0').toString().replace(/,/g, '')) || 0
                    })).filter(row => row.region && row.cropGroup);
                    
                    if (csvData.length > 0) {
                        initializeFilters();
                        updateDisplay();
                    }
                }
            });
        }

        function initializeFilters() {
            // 작목군 필터 초기화
            const cropGroups = [...new Set(csvData.map(item => item.cropGroup))].sort();
            const cropGroupFilter = document.getElementById('cropGroupFilter');
            cropGroupFilter.innerHTML = '<div class="filter-item active" data-crop-group="">전체</div>';
            cropGroups.forEach(group => {
                cropGroupFilter.innerHTML += `<div class="filter-item" data-crop-group="${group}">${group}</div>`;
            });

            // 연도 필터 초기화 (전체 옵션 제거, 첫 번째 년도를 기본값으로 설정)
            const years = [...new Set(csvData.map(item => item.year))].sort();
            const yearFilter = document.getElementById('yearFilter');
            yearFilter.innerHTML = '';
            years.forEach((year, index) => {
                const isActive = index === years.length - 1; // 마지막 년도(최신)를 기본 선택
                yearFilter.innerHTML += `<div class="year-btn ${isActive ? 'active' : ''}" data-year="${year}">${year}</div>`;
                if (isActive) {
                    currentFilters.year = year;
                }
            });

            updateCrops();
            attachFilterEvents();
        }

        function updateCrops() {
            let filtered = csvData.filter(item => item.region === currentFilters.region);
            if (currentFilters.cropGroup) {
                filtered = filtered.filter(item => item.cropGroup === currentFilters.cropGroup);
            }
            
            const crops = [...new Set(filtered.map(item => item.crop))].sort();
            const cropFilter = document.getElementById('cropFilter');
            cropFilter.innerHTML = '<div class="filter-item active" data-crop="">전체</div>';
            crops.forEach(crop => {
                cropFilter.innerHTML += `<div class="filter-item" data-crop="${crop}">${crop}</div>`;
            });
        }

        function attachFilterEvents() {
            // 지역 필터
            document.querySelectorAll('#regionFilter .filter-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('#regionFilter .filter-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    currentFilters.region = this.dataset.region;
                    updateCrops();
                    updateDisplay();
                });
            });

            // 작목군 필터
            document.addEventListener('click', function(e) {
                if (e.target.matches('#cropGroupFilter .filter-item')) {
                    document.querySelectorAll('#cropGroupFilter .filter-item').forEach(i => i.classList.remove('active'));
                    e.target.classList.add('active');
                    currentFilters.cropGroup = e.target.dataset.cropGroup;
                    currentFilters.crop = '';
                    updateCrops();
                    updateDisplay();
                }
            });

            // 작목 필터
            document.addEventListener('click', function(e) {
                if (e.target.matches('#cropFilter .filter-item')) {
                    document.querySelectorAll('#cropFilter .filter-item').forEach(i => i.classList.remove('active'));
                    e.target.classList.add('active');
                    currentFilters.crop = e.target.dataset.crop;
                    updateDisplay();
                }
            });

            // 연도 필터
            document.addEventListener('click', function(e) {
                if (e.target.matches('#yearFilter .year-btn')) {
                    document.querySelectorAll('#yearFilter .year-btn').forEach(i => i.classList.remove('active'));
                    e.target.classList.add('active');
                    currentFilters.year = e.target.dataset.year;
                    updateDisplay();
                }
            });
        }

        function updateDisplay() {
            filterData();
            updateSummary();
            updateSummaryTitle(); // 요약 제목 업데이트 추가
            updateTable();
            updateCharts();
        }

        function filterData() {
            filteredData = csvData.filter(item => {
                return item.region === currentFilters.region &&
                       (!currentFilters.cropGroup || item.cropGroup === currentFilters.cropGroup) &&
                       (!currentFilters.crop || item.crop === currentFilters.crop) &&
                       (!currentFilters.year || item.year === currentFilters.year);
            });
        }

        function updateSummary() {
            const income = filteredData.filter(i => i.category === '소득').reduce((a, b) => a + b.value, 0);
            const rateArr = filteredData.filter(i => i.category === '소득률');
            const avgRate = rateArr.reduce((a, b) => a + b.value, 0) / (rateArr.length || 1);
            document.getElementById('totalIncome').textContent = `₩${income.toLocaleString()}`;
            document.getElementById('totalRate').textContent = `${avgRate.toFixed(1)}%`;
        }

        function updateSummaryTitle() {
            const selectedYear = currentFilters.year || '2023';
            const selectedRegion = currentFilters.region || '전국';
            const selectedCrop = currentFilters.crop || '';
            
            let titleParts = [selectedYear + '년', selectedRegion];
            
            if (selectedCrop) {
                titleParts.push(selectedCrop);
            }
            
            titleParts.push('소득분석표');
            
            const summaryTitle = document.getElementById('summaryTitle');
            summaryTitle.textContent = titleParts.join(' ');
        }

        function updateTable() {
            const tableBody = document.getElementById('detailTableBody');
            
            // 작목별 비목 순서 정의
            const itemOrder = {
                '쌀': ['주산물가액', '주산물수량', '부산물가액', '수취가격', '종자·종묘비', '보통(무기질)비료비', '부산물(유기질)비료비', '농약비', '수도광열비', '기타재료비', '대농구상각비', '영농시설상각비', '자동차비', '기타비용', '농기계·시설임차료', '토지임차료', '위탁영농비', '고용노동비', '자가노동비', '고정자본용역비', '토지자본용역비'],
                '콩': ['주산물가액', '주산물수량', '부산물가액', '수취가격', '종자·종묘비', '보통(무기질)비료비', '부산물(유기질)비료비', '농약비', '수도광열비', '기타재료비', '대농구상각비', '영농시설상각비', '자동차비', '기타비용', '농기계·시설임차료', '토지임차료', '위탁영농비', '고용노동비', '자가노동비', '고정자본용역비', '토지자본용역비'],
                '고추': ['주산물가액', '주산물수량', '부산물가액', '수취가격', '종자·종묘비', '보통(무기질)비료비', '부산물(유기질)비료비', '농약비', '수도광열비', '기타재료비', '대농구상각비', '영농시설상각비', '자동차비', '기타비용', '농기계·시설임차료', '토지임차료', '위탁영농비', '고용노동비', '자가노동비', '고정자본용역비', '토지자본용역비'],
                '양파': ['주산물가액', '주산물수량', '부산물가액', '수취가격', '종자·종묘비', '보통(무기질)비료비', '부산물(유기질)비료비', '농약비', '수도광열비', '기타재료비', '대농구상각비', '영농시설상각비', '자동차비', '기타비용', '농기계·시설임차료', '토지임차료', '위탁영농비', '고용노동비', '자가노동비', '고정자본용역비', '토지자본용역비'],
                '마늘': ['주산물가액', '주산물수량', '부산물가액', '수취가격', '종자·종묘비', '보통(무기질)비료비', '부산물(유기질)비료비', '농약비', '수도광열비', '기타재료비', '대농구상각비', '영농시설상각비', '자동차비', '기타비용', '농기계·시설임차료', '토지임차료', '위탁영농비', '고용노동비', '자가노동비', '고정자본용역비', '토지자본용역비'],
                '기본' : ['주산물가액', '주산물수량', '부산물가액', '수취가격', '종자·종묘비', '보통(무기질)비료비', '부산물(유기질)비료비', '농약비', '수도광열비', '기타재료비', '대농구상각비', '영농시설상각비', '수리유지비', '기타비용', '농기계·시설임차료', '토지임차료', '위탁영농비', '고용노동비', '자가노동비', '고정자본용역비', '토지자본용역비']
            };
            
            // 현재 선택된 작목군에 따른 순서 결정
            let currentOrder = itemOrder['기본']; // 기본값
            if (currentFilters.cropGroup && itemOrder[currentFilters.cropGroup]) {
                currentOrder = itemOrder[currentFilters.cropGroup];
            }
            
            // 구분이 '비목'인 데이터만 필터링
            const tableFiltered = filteredData.filter(item => item.category === '비목');
            
            // 비목 데이터를 value 기준으로 그룹화
            const itemMap = {};
            tableFiltered.forEach(item => {
                itemMap[item.value] = item;
            });
            
            let html = '';
            
            // 정의된 순서대로 표시
            currentOrder.forEach(itemName => {
                if (itemMap[itemName]) {
                    // 실제 값이 있는 경우 해당 값을 표시 (향후 확장 가능)
                    const actualValue = itemMap[itemName].value !== undefined ? itemMap[itemName].value.toLocaleString() : '-';
                    html += `<tr><td>${itemName}</td><td>${actualValue}</td></tr>`;
                } else {
                    // 데이터가 없는 경우에도 순서에 따라 표시
                    html += `<tr><td>${itemName}</td><td>-</td></tr>`;
                }
            });
            
            // 정의되지 않은 추가 비목이 있는 경우 맨 아래에 표시
            Object.keys(itemMap).forEach(itemName => {
                if (!currentOrder.includes(itemName)) {
                    const actualValue = itemMap[itemName].value !== undefined ? itemMap[itemName].value.toLocaleString() : '-';
                    html += `<tr><td>${itemName}</td><td>${actualValue}</td></tr>`;
                }
            })
            
            tableBody.innerHTML = html || '<tr><td colspan="2">데이터가 없습니다.</td></tr>';
        }

        function updateCharts() {
            const fixedYears = ['2019', '2020', '2021', '2022', '2023'];
            const chartData = { labels: fixedYears.map(y => y + '년'), datasets: [] };
        
            const categories = [
                { name: '총수입', color: '#3b82f6' },
                { name: '경영비', color: '#ef4444' },
                { name: '소득', color: '#10b981' }
            ];
        
            categories.forEach(cat => {
                const values = fixedYears.map(y => {
                    const match = csvData.find(row =>
                        row.category === cat.name &&
                        row.year === y &&
                        row.region === currentFilters.region &&
                        (!currentFilters.cropGroup || row.cropGroup === currentFilters.cropGroup) &&
                        (!currentFilters.crop || row.crop === currentFilters.crop)
                    );
                    return match ? match.value : 0;
                });
        
                chartData.datasets.push({
                    label: cat.name,
                    data: values,
                    borderColor: cat.color,
                    backgroundColor: cat.color + '30',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                });
            });
        
            const ctx = document.getElementById('incomeChart').getContext('2d');
            if (charts['incomeChart']) charts['incomeChart'].destroy();
        
            charts['incomeChart'] = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        x: { grid: { display: false } },
                        y: {
                            ticks: {
                                callback: val => val.toLocaleString()
                            }
                        }
                    }
                }
            });
        }


        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            loadCSVFromGitHub();
        });
    </script>
</body>
</html>
