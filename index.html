<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>소득조사 대시보드</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Malgun Gothic', 'Segoe UI', sans-serif;
            background: #f8f9fa;
            font-size: 11px;
            overflow: auto;
        }

        .header {
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
            color: white;
            padding: 6px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            border-bottom: 2px solid #1e40af;
            height: 35px;
        }

        .header-left {
            font-weight: bold;
        }

        .header-right {
            display: flex;
            gap: 20px;
        }

        .container {
            display: grid;
            grid-template-columns: 220px 1fr 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            gap: 10px;
            padding: 10px;
            /* height: calc(100vh - 35px); ← 이 줄 제거 */
            min-height: 100vh;
            overflow: auto; /* 스크롤 허용 */;
        }

        /* 사이드바 - 세로로 3행 차지 */
        .sidebar {
            grid-column: 1 / 2;
            grid-row: 1 / 4;
            background: #ffffff;
            border-right: 1px solid #e5e7eb;
            padding: 10px;
            overflow-y: auto;
        }

        /* 소득분석표 - 세로로 3행 차지 */
        .income-analysis-section {
            grid-column: 2 / 3;
            grid-row: 1 / 4;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* 총수입 그래프 */
        .total-income-chart {
            grid-column: 3 / 4;
            grid-row: 1 / 2;
        }

        /* 자가노동 그래프 */
        .self-labor-chart {
            grid-column: 4 / 5;
            grid-row: 1 / 2;
        }

        /* 고용노동 그래프 */
        .hired-labor-chart {
            grid-column: 5 / 6;
            grid-row: 1 / 2;
        }

        /* 년도별 노동 그래프 */
        .annual-labor-chart {
            grid-column: 4 / 6;
            grid-row: 2 / 3;
        }

        /* 소득 그래프 */
        .income-chart {
            grid-column: 4 / 6;
            grid-row: 3 / 4;
        }

        .chart-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 12px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 10px;
            text-align: center;
        }

        .chart-container {
            position: relative;
            height: 220px;
        }

        .income-chart .chart-container {
            height: 180px;
        }

        .filter-section {
            margin-bottom: 15px;
        }

        .filter-title {
            background: #3b82f6;
            color: white;
            padding: 6px 10px;
            font-weight: bold;
            font-size: 11px;
            border-radius: 3px 3px 0 0;
        }

        .filter-content {
            border: 1px solid #e5e7eb;
            border-top: none;
            background: white;
            max-height: 120px;
            overflow-y: auto;
        }

        .filter-item {
            padding: 6px 10px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            font-size: 11px;
            transition: background 0.2s;
        }

        .filter-item:hover {
            background: #f3f4f6;
        }

        .filter-item.active {
            background: #dbeafe;
            color: #1e40af;
            font-weight: bold;
        }

        .year-buttons {
            background: white;
            border: 1px solid #e5e7eb;
            border-top: none;
        }

        .year-btn {
            padding: 6px 10px;
            border: none;
            border-bottom: 1px solid #f3f4f6;
            background: white;
            cursor: pointer;
            font-size: 11px;
            transition: background 0.2s;
            width: 100%;
            text-align: left;
        }

        .year-btn:hover {
            background: #f3f4f6;
        }

        .year-btn.active {
            background: #dbeafe;
            color: #1e40af;
            font-weight: bold;
        }

        .income-analysis-layout {
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: 100%;
        }

        .main-summary-box {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border: 2px solid #3b82f6;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }

        .main-summary-value {
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
            margin: 6px 0;
        }

        .summary-sublabel {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
        }

        .table-wrapper {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
        }

        .section-header {
            background: #f3f4f6 !important;
            font-weight: bold;
            color: #374151;
        }

        .section-header td {
            padding: 8px 6px;
            border-bottom: 2px solid #d1d5db;
            text-align: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
        }

        th {
            background: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
            padding: 6px 5px;
            text-align: left;
            font-weight: bold;
            color: #374151;
            position: sticky;
            top: 0;
        }

        td {
            padding: 5px 6px;
            border-bottom: 1px solid #f3f4f6;
            color: #1f2937;
        }

        tr:hover {
            background: #f9fafb;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            color: #6b7280;
        }

        .toggle-btn {
            display: none;
            background: #3b82f6;
            color: white;
            border: none;
            padding: 6px 12px;
            margin: 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }

        .sidebar.collapsed {
            height: auto;
            max-height: 50px;
            overflow: hidden;
        }

        .sidebar.collapsed .filter-section {
            display: none;
        }

        /* 반응형 디자인 */
        @media (max-width: 1400px) {
            .container {
                grid-template-columns: 220px 1fr 1fr;
                grid-template-rows: auto auto auto auto;
            }
            
            .income-analysis-section {
                grid-column: 2 / 4;
                grid-row: 1 / 2;
            }
            
            .total-income-chart {
                grid-column: 2 / 3;
                grid-row: 2 / 3;
            }
            
            .self-labor-chart {
                grid-column: 3 / 4;
                grid-row: 2 / 3;
            }
            
            .hired-labor-chart {
                grid-column: 2 / 3;
                grid-row: 3 / 4;
            }
            
            .annual-labor-chart {
                grid-column: 3 / 4;
                grid-row: 3 / 4;
            }
            
            .income-chart {
                grid-column: 2 / 4;
                grid-row: 4 / 5;
            }
        }

        @media (max-width: 768px) {
            .container {
                display: flex;
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
                max-height: 50px;
                overflow: hidden;
                transition: max-height 0.3s ease;
            }

            .sidebar.expanded {
                max-height: 350px;
            }

            .toggle-btn {
                display: block;
            }

            .sidebar.collapsed .filter-section,
            .sidebar:not(.expanded) .filter-section {
                display: none;
            }

            .chart-card {
                padding: 8px;
                margin-bottom: 10px;
            }

            .filter-content {
                max-height: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">소득조사 대시보드</div>
        <div class="header-right">
            <span>현황</span>
        </div>
    </div>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <button class="toggle-btn" onclick="toggleSidebar()">필터 열기/닫기</button>
            <div class="filter-section">
                <div class="filter-title">지역구분</div>
                <div class="filter-content" id="regionFilter">
                    <div class="filter-item active" data-region="전국">전국</div>
                    <div class="filter-item" data-region="강원">강원</div>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-title">작목</div>
                <div class="filter-content" id="cropGroupFilter">
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-title">작목상세</div>
                <div class="filter-content" id="cropFilter">
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-title">년</div>
                <div class="year-buttons" id="yearFilter">
                </div>
            </div>
        </div>

        <div class="chart-card income-analysis-section">
            <div class="chart-title" id="summaryTitle">2023년 전국 소득분석표</div>
            <div class="income-analysis-layout">
                <div class="main-summary-box" style="font-weight: bold; font-size: 14px; color: #6B1E6D;">
                    소득 <span id="totalIncome">₩0</span> / 소득률 <span id="totalRate">0%</span>
                </div>
                <div class="table-wrapper">
                    <table>
                        <tbody id="detailTableBody">
                            <tr><td colspan="2" class="loading">데이터를 불러오는 중...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="chart-card total-income-chart">
            <div class="chart-title">총수입</div>
            <div class="chart-container">
                <canvas id="incomeChart"></canvas>
            </div>
        </div>

        <div class="chart-card self-labor-chart">
            <div class="chart-title">자가노동그래프</div>
            <div class="chart-container">
                <canvas id="selfLaborChart"></canvas>
            </div>
        </div>

        <div class="chart-card hired-labor-chart">
            <div class="chart-title">고용노동그래프</div>
            <div class="chart-container">
                <canvas id="hiredLaborChart"></canvas>
            </div>
        </div>

        <div class="chart-card annual-labor-chart">
            <div class="chart-title">년도별 노동그래프</div>
            <div class="chart-container">
                <canvas id="annualLaborChart"></canvas>
            </div>
        </div>

        <div class="chart-card income-chart">
            <div class="chart-title">소득그래프</div>
            <div class="chart-container">
                <canvas id="cropIncomeChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let csvData = [];
        let filteredData = [];
        let currentFilters = {
            region: '전국',
            cropGroup: '',
            crop: '',
            year: '2023'
        };
        let charts = {};

        // GitHub에서 CSV 파일 불러오기
        async function loadCSVFromGitHub() {
            try {
                const csvUrl = 'https://raw.githubusercontent.com/soonpark2/project1/main/DB.csv';
                const response = await fetch(csvUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                parseCSV(csvText);
            } catch (error) {
                console.error('CSV 파일 로드 오류:', error);
                showError(`GitHub에서 CSV 파일을 불러올 수 없습니다: ${error.message}`);
                loadTestData();
            }
        }

        // 테스트 데이터 (백업용)
        function loadTestData() {
            const testData = `지역구분,년,작목군,작목,구분,값
전국,2023,쌀,쌀,소득,5000000
전국,2023,쌀,쌀,소득률,18.8
전국,2023,쌀,쌀,총수입,8500000
전국,2023,쌀,쌀,경영비,3000000
전국,2023,쌀,쌀,생산비,3500000
전국,2023,쌀,쌀,주산물가액,8000000
전국,2023,쌀,쌀,주산물수량,755
전국,2023,쌀,쌀,부산물가액,500000
전국,2023,쌀,쌀,수취가격,5299
전국,2023,쌀,쌀,자가노동시간,100.1
전국,2023,쌀,쌀,자가노동시간(남),70.6
전국,2023,쌀,쌀,자가노동시간(여),29.5
전국,2023,쌀,쌀,고용노동시간,18.0
전국,2023,쌀,쌀,고용노동시간(남),3.3
전국,2023,쌀,쌀,고용노동시간(여),14.7
전국,2022,쌀,쌀,자가노동시간,102.0
전국,2022,쌀,쌀,고용노동시간,15.8
전국,2021,쌀,쌀,자가노동시간,109.3
전국,2021,쌀,쌀,고용노동시간,7.3
전국,2020,쌀,쌀,자가노동시간,113.7
전국,2020,쌀,쌀,고용노동시간,10.8
전국,2019,쌀,쌀,자가노동시간,118.0
전국,2019,쌀,쌀,고용노동시간,11.8
전국,2023,쌀,쌀,종자·종묘비,79547
전국,2023,쌀,쌀,보통(무기질)비료비,103292
전국,2023,쌀,쌀,부산물(유기질)비료비,50000
전국,2023,쌀,쌀,농약비,292575
전국,2023,쌀,쌀,수도광열비,70253
전국,2023,쌀,쌀,기타재료비,286741
전국,2023,쌀,쌀,대농구상각비,1161
전국,2023,쌀,쌀,영농시설상각비,290091
전국,2023,쌀,쌀,자동차비,136810
전국,2023,쌀,쌀,기타비용,14502
전국,2023,쌀,쌀,농기계·시설임차료,15610
전국,2023,쌀,쌀,토지임차료,6011
전국,2023,쌀,쌀,위탁영농비,66597
전국,2023,쌀,쌀,고용노동비,275979
전국,2023,쌀,쌀,자가노동비,2248577
전국,2023,쌀,쌀,고정자본용역비,34104
전국,2023,쌀,쌀,토지자본용역비,59294
전국,2023,과일,사과,소득,4500000
전국,2023,과일,사과,소득률,17.2
전국,2023,과일,사과,총수입,7000000
전국,2023,과일,사과,경영비,2000000
전국,2023,과일,사과,생산비,2500000
전국,2023,과일,사과,주산물가액,6800000
전국,2023,과일,사과,자가노동시간,95.5
전국,2023,과일,사과,자가노동시간(남),65.2
전국,2023,과일,사과,자가노동시간(여),30.3
전국,2023,과일,사과,고용노동시간,25.2
전국,2023,과일,사과,고용노동시간(남),12.1
전국,2023,과일,사과,고용노동시간(여),13.1
전국,2023,과일,사과,종자·종묘비,150000
전국,2023,과일,사과,보통(무기질)비료비,200000
전국,2023,과일,사과,농약비,300000
전국,2023,채소,감자,소득,3200000
전국,2023,채소,감자,소득률,19.8
전국,2023,채소,감자,총수입,4000000
전국,2023,채소,감자,경영비,1200000
전국,2023,채소,감자,생산비,1500000
전국,2023,채소,감자,주산물가액,3800000
전국,2023,채소,감자,자가노동시간,85.2
전국,2023,채소,감자,자가노동시간(남),55.1
전국,2023,채소,감자,자가노동시간(여),30.1
전국,2023,채소,감자,고용노동시간,12.5
전국,2023,채소,감자,고용노동시간(남),8.2
전국,2023,채소,감자,고용노동시간(여),4.3
강원,2023,과일,사과,소득,1000000
강원,2023,과일,사과,소득률,16.5
강원,2023,과일,사과,총수입,2000000
강원,2023,과일,사과,경영비,800000
강원,2023,과일,사과,생산비,1000000
강원,2023,과일,사과,주산물가액,1900000
강원,2023,과일,사과,자가노동시간,90.1
강원,2023,과일,사과,자가노동시간(남),60.5
강원,2023,과일,사과,자가노동시간(여),29.6
강원,2023,과일,사과,고용노동시간,20.1
강원,2023,과일,사과,고용노동시간(남),10.2
강원,2023,과일,사과,고용노동시간(여),9.9
강원,2023,채소,감자,소득,2500000
강원,2023,채소,감자,소득률,19.8
강원,2023,채소,감자,총수입,4000000
강원,2023,채소,감자,경영비,1200000
강원,2023,채소,감자,생산비,1500000
강원,2023,채소,감자,주산물가액,3800000
강원,2023,채소,감자,자가노동시간,80.3
강원,2023,채소,감자,자가노동시간(남),50.2
강원,2023,채소,감자,자가노동시간(여),30.1
강원,2023,채소,감자,고용노동시간,15.2
강원,2023,채소,감자,고용노동시간(남),10.1
강원,2023,채소,감자,고용노동시간(여),5.1`;
            
            parseCSV(testData);
        }

        function showError(message) {
            const tableBody = document.getElementById('detailTableBody');
            tableBody.innerHTML = `<tr><td colspan="2" style="text-align: center; color: #ef4444;">${message}</td></tr>`;
        }

        function parseCSV(csvText) {
            Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    csvData = results.data.map(row => ({
                        region: (row['지역구분'] || '').trim(),
                        year: (row['년'] || '').trim(),
                        cropGroup: (row['작목군'] || '').trim(),
                        crop: (row['작목'] || '').trim(),
                        category: (row['구분'] || '').trim(),
                        value: parseFloat((row['값'] || '0').toString().replace(/,/g, '')) || 0
                    })).filter(row => row.region && row.cropGroup);
                    
                    if (csvData.length > 0) {
                        initializeFilters();
                        updateDisplay();
                    }
                }
            });
        }

        function initializeFilters() {
            // 작목군 필터 초기화
            const cropGroups = [...new Set(csvData.map(item => item.cropGroup))].sort();
            const cropGroupFilter = document.getElementById('cropGroupFilter');
            cropGroupFilter.innerHTML = '<div class="filter-item active" data-crop-group="">전체</div>';
            cropGroups.forEach(group => {
                cropGroupFilter.innerHTML += `<div class="filter-item" data-crop-group="${group}">${group}</div>`;
            });

            // 연도 필터 초기화 (전체 옵션 제거, 첫 번째 년도를 기본값으로 설정)
            const years = [...new Set(csvData.map(item => item.year))].sort();
            const yearFilter = document.getElementById('yearFilter');
            yearFilter.innerHTML = '';
            years.forEach((year, index) => {
                const isActive = index === years.length - 1; // 마지막 년도(최신)를 기본 선택
                yearFilter.innerHTML += `<div class="year-btn ${isActive ? 'active' : ''}" data-year="${year}">${year}</div>`;
                if (isActive) {
                    currentFilters.year = year;
                }
            });

            updateCrops();
            attachFilterEvents();
        }

        function updateCrops() {
            let filtered = csvData.filter(item => item.region === currentFilters.region);
            if (currentFilters.cropGroup) {
                filtered = filtered.filter(item => item.cropGroup === currentFilters.cropGroup);
            }
            
            const crops = [...new Set(filtered.map(item => item.crop))].sort();
            const cropFilter = document.getElementById('cropFilter');
            cropFilter.innerHTML = '<div class="filter-item active" data-crop="">전체</div>';
            crops.forEach(crop => {
                cropFilter.innerHTML += `<div class="filter-item" data-crop="${crop}">${crop}</div>`;
            });
        }

        function attachFilterEvents() {
            // 지역 필터
            document.querySelectorAll('#regionFilter .filter-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('#regionFilter .filter-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    currentFilters.region = this.dataset.region;
                    updateCrops();
                    updateDisplay();
                });
            });

            // 작목군 필터
            document.addEventListener('click', function(e) {
                if (e.target.matches('#cropGroupFilter .filter-item')) {
                    document.querySelectorAll('#cropGroupFilter .filter-item').forEach(i => i.classList.remove('active'));
                    e.target.classList.add('active');
                    currentFilters.cropGroup = e.target.dataset.cropGroup;
                    currentFilters.crop = '';
                    updateCrops();
                    updateDisplay();
                }
            });

            // 작목 필터
            document.addEventListener('click', function(e) {
                if (e.target.matches('#cropFilter .filter-item')) {
                    document.querySelectorAll('#cropFilter .filter-item').forEach(i => i.classList.remove('active'));
                    e.target.classList.add('active');
                    currentFilters.crop = e.target.dataset.crop;
                    updateDisplay();
                }
            });

            // 연도 필터
            document.addEventListener('click', function(e) {
                if (e.target.matches('#yearFilter .year-btn')) {
                    document.querySelectorAll('#yearFilter .year-btn').forEach(i => i.classList.remove('active'));
                    e.target.classList.add('active');
                    currentFilters.year = e.target.dataset.year;
                    updateDisplay();
                }
            });
        }

        function updateDisplay() {
            filterData();
            updateSummary();
            updateSummaryTitle(); // 요약 제목 업데이트 추가
            updateTable();
            updateCharts();
        }

        function filterData() {
            filteredData = csvData.filter(item => {
                return item.region === currentFilters.region &&
                       (!currentFilters.cropGroup || item.cropGroup === currentFilters.cropGroup) &&
                       (!currentFilters.crop || item.crop === currentFilters.crop) &&
                       (!currentFilters.year || item.year === currentFilters.year);
            });
        }

        function updateSummary() {
            const income = filteredData.filter(i => i.category === '소득').reduce((a, b) => a + b.value, 0);
            const rateArr = filteredData.filter(i => i.category === '소득률');
            const avgRate = rateArr.reduce((a, b) => a + b.value, 0) / (rateArr.length || 1);
            
            document.getElementById('totalIncome').textContent = `₩${income.toLocaleString()}`;
            document.getElementById('totalRate').textContent = `${avgRate.toFixed(1)}%`;
        }

        function updateSummaryTitle() {
            const selectedYear = currentFilters.year || '2023';
            const selectedRegion = currentFilters.region || '전국';
            const selectedCrop = currentFilters.crop || '';
            
            let titleParts = [selectedYear + '년', selectedRegion];
            
            if (selectedCrop) {
                titleParts.push(selectedCrop);
            }
            
            titleParts.push('소득분석표');
            
            const summaryTitle = document.getElementById('summaryTitle');
            summaryTitle.textContent = titleParts.join(' ');
        }

        function updateTable() {
            const tableBody = document.getElementById('detailTableBody');
            
            // 현재 필터링된 데이터에서 실제 값을 가진 비목 데이터 매핑
            const itemValueMap = {};
            
            filteredData.forEach(item => {
                itemValueMap[item.category] = item.value;
            });
            
            let html = '';
            
            // 총수입 박스
            const totalRevenue = itemValueMap['총수입'] || 0;
            html += `<tr style="background: #f3f4f6;"><td colspan="2" style="text-align: center; font-weight: bold; padding: 8px;">총수입 ₩${totalRevenue.toLocaleString()}</td></tr>`;
            
            const revenueItems = ['주산물가액', '주산물수량', '부산물가액', '수취가격'];
            revenueItems.forEach(itemName => {
                const value = itemValueMap[itemName];
                const displayValue = value !== undefined ? 
                    (itemName === '주산물수량' ? value.toLocaleString() : (typeof value === 'number' ? value.toLocaleString() : value)) : '-';
                html += `<tr><td>${itemName}</td><td>${displayValue}</td></tr>`;
            });
            html += '<tr><td colspan="2" style="border-bottom: 2px solid #d1d5db; padding: 0;"></td></tr>';
            
            // 중간재비 박스 - 작목군/작목 조건에 따라 항목 설정
            let allMaterialCostItems = [];
            
            if (currentFilters.cropGroup === '과수') {
                allMaterialCostItems = [
                    '과수원조성비', '보통(무기질)비료비', '부산물(유기질)비료비',
                    '농약비', '수도광열비', '기타재료비', '소농구비',
                    '대농구상각비', '영농시설상각비', '수리·유지비', '기타비용'
                ];
            } else if (['쌀', '콩', '고추', '양파', '마늘'].includes(currentFilters.crop)) {
                allMaterialCostItems = [
                    '종자·종묘비', '보통(무기질)비료비', '부산물(유기질)비료비',
                    '농약비', '수도광열비', '기타재료비', '소농구비',
                    '대농구상각비', '영농시설상각비', '자동차비', '기타비용'
                ];
            } else {
                // 기본값 또는 기타 작목일 때
                allMaterialCostItems = [
                    '종자·종묘비', '보통(무기질)비료비', '부산물(유기질)비료비',
                    '농약비', '수도광열비', '기타재료비', '소농구비',
                    '대농구상각비', '영농시설상각비', '수리·유지비', '기타비용'
                ];
            }
            
            // 중간재비 총합 계산
            let totalMaterialCost = 0;
            allMaterialCostItems.forEach(itemName => {
                const value = itemValueMap[itemName];
                if (typeof value === 'number') {
                    totalMaterialCost += value;
                }
            });
            html += `<tr style="background: #f3f4f6;"><td colspan="2" style="text-align: center; font-weight: bold; padding: 8px;">중간재비 ₩${totalMaterialCost.toLocaleString()}</td></tr>`;
            
            // 항목별 출력
            allMaterialCostItems.forEach(itemName => {
                const value = itemValueMap[itemName];
                const displayValue = value !== undefined ? value.toLocaleString() : '-';
                html += `<tr><td>${itemName}</td><td>${displayValue}</td></tr>`;
            });
            
            // 경영비 박스
            const totalCost = itemValueMap['경영비'] || 0;
            html += `<tr style="background: #f3f4f6;"><td colspan="2" style="text-align: center; font-weight: bold; padding: 8px;">경영비 ₩${totalCost.toLocaleString()}</td></tr>`;
            
            const costItems = ['농기계·시설임차료', '토지임차료', '위탁영농비', '고용노동비'];
            costItems.forEach(itemName => {
                const value = itemValueMap[itemName];
                const displayValue = value !== undefined ? 
                    (typeof value === 'number' ? value.toLocaleString() : value) : '-';
                html += `<tr><td>${itemName}</td><td>${displayValue}</td></tr>`;
            });
            html += '<tr><td colspan="2" style="border-bottom: 2px solid #d1d5db; padding: 0;"></td></tr>';
            
            // 생산비 박스
            const totalProductionCost = itemValueMap['생산비'] || 0;
            html += `<tr style="background: #f3f4f6;"><td colspan="2" style="text-align: center; font-weight: bold; padding: 8px;">생산비 ₩${totalProductionCost.toLocaleString()}</td></tr>`;
            
            const productionItems = ['자가노동비', '유동자본용역비', '고정자본용역비', '토지자본용역비'];
            productionItems.forEach(itemName => {
                const value = itemValueMap[itemName];
                const displayValue = value !== undefined ? 
                    (typeof value === 'number' ? value.toLocaleString() : value) : '-';
                html += `<tr><td>${itemName}</td><td>${displayValue}</td></tr>`;
            });
            
            tableBody.innerHTML = html || '<tr><td colspan="2">데이터가 없습니다.</td></tr>';
        }

        function updateCharts() {
            const fixedYears = ['2019', '2020', '2021', '2022', '2023'];
            const chartData = { labels: fixedYears.map(y => y + '년'), datasets: [] };
        
            const categories = [
                { name: '총수입', color: '#3b82f6' },
                { name: '경영비', color: '#ef4444' },
                { name: '소득', color: '#10b981' }
            ];
        
            categories.forEach(cat => {
                const values = fixedYears.map(y => {
                    const match = csvData.find(row =>
                        row.category === cat.name &&
                        row.year === y &&
                        row.region === currentFilters.region &&
                        (!currentFilters.cropGroup || row.cropGroup === currentFilters.cropGroup) &&
                        (!currentFilters.crop || row.crop === currentFilters.crop)
                    );
                    return match ? match.value : 0;
                });
        
                chartData.datasets.push({
                    label: cat.name,
                    data: values,
                    borderColor: cat.color,
                    backgroundColor: cat.color + '30',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                });
            });
        
            const ctx = document.getElementById('incomeChart').getContext('2d');
            if (charts['incomeChart']) charts['incomeChart'].destroy();
        
            charts['incomeChart'] = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            position: 'top',
                            labels: { font: { size: 10 } }
                        } 
                    },
                    scales: {
                        x: { 
                            grid: { display: false },
                            ticks: { font: { size: 9 } }
                        },
                        y: {
                            ticks: {
                                font: { size: 9 },
                                callback: val => val.toLocaleString()
                            }
                        }
                    }
                }
            });

            // 자가 노동시간 도넛 차트
            updateSelfLaborChart();
            
            // 고용 노동시간 도넛 차트
            updateHiredLaborChart();
            
            // 년도별 노동시간 누적 차트
            updateAnnualLaborChart();
            
            // 작목별 소득 차트
            updateCropIncomeChart();
        }

        function updateSelfLaborChart() {
            const selfLaborTotal = filteredData.find(item => item.category === '자가노동시간')?.value || 0;
            const selfLaborMale = filteredData.find(item => item.category === '자가노동시간(남)')?.value || 0;
            const selfLaborFemale = filteredData.find(item => item.category === '자가노동시간(여)')?.value || 0;
            
            const ctx = document.getElementById('selfLaborChart').getContext('2d');
            if (charts['selfLaborChart']) charts['selfLaborChart'].destroy();
            
            charts['selfLaborChart'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['남성', '여성'],
                    datasets: [{
                        data: [selfLaborMale, selfLaborFemale],
                        backgroundColor: ['#3b82f6', '#06b6d4'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: { font: { size: 9 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + '시간';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateHiredLaborChart() {
            const hiredLaborTotal = filteredData.find(item => item.category === '고용노동시간')?.value || 0;
            const hiredLaborMale = filteredData.find(item => item.category === '고용노동시간(남)')?.value || 0;
            const hiredLaborFemale = filteredData.find(item => item.category === '고용노동시간(여)')?.value || 0;
            
            const ctx = document.getElementById('hiredLaborChart').getContext('2d');
            if (charts['hiredLaborChart']) charts['hiredLaborChart'].destroy();
            
            charts['hiredLaborChart'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['남성', '여성'],
                    datasets: [{
                        data: [hiredLaborMale, hiredLaborFemale],
                        backgroundColor: ['#8b5cf6', '#ec4899'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: { font: { size: 9 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + '시간';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateAnnualLaborChart() {
            const fixedYears = ['2019', '2020', '2021', '2022', '2023'];
            
            const selfLaborData = fixedYears.map(y => {
                const match = csvData.find(row =>
                    row.category === '자가노동시간' &&
                    row.year === y &&
                    row.region === currentFilters.region &&
                    (!currentFilters.cropGroup || row.cropGroup === currentFilters.cropGroup) &&
                    (!currentFilters.crop || row.crop === currentFilters.crop)
                );
                return match ? match.value : 0;
            });
            
            const hiredLaborData = fixedYears.map(y => {
                const match = csvData.find(row =>
                    row.category === '고용노동시간' &&
                    row.year === y &&
                    row.region === currentFilters.region &&
                    (!currentFilters.cropGroup || row.cropGroup === currentFilters.cropGroup) &&
                    (!currentFilters.crop || row.crop === currentFilters.crop)
                );
                return match ? match.value : 0;
            });
            
            const ctx = document.getElementById('annualLaborChart').getContext('2d');
            if (charts['annualLaborChart']) charts['annualLaborChart'].destroy();
            
            charts['annualLaborChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: fixedYears.map(y => y + '년'),
                    datasets: [
                        {
                            label: '자가노동',
                            data: selfLaborData,
                            backgroundColor: '#3b82f6',
                            borderColor: '#1e40af',
                            borderWidth: 1
                        },
                        {
                            label: '고용노동',
                            data: hiredLaborData,
                            backgroundColor: '#8b5cf6',
                            borderColor: '#7c3aed',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            grid: { display: false },
                            ticks: { font: { size: 9 } }
                        },
                        y: {
                            stacked: true,
                            ticks: {
                                font: { size: 9 },
                                callback: val => val + '시간'
                            }
                        }
                    },
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: { font: { size: 9 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + '시간';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateCropIncomeChart() {
            // 현재 지역과 년도로 필터링된 작목별 소득 데이터
            let cropIncomeData = csvData.filter(item => {
                return item.category === '소득' &&
                       item.region === currentFilters.region &&
                       item.year === currentFilters.year &&
                       (!currentFilters.cropGroup || item.cropGroup === currentFilters.cropGroup);
            });
            
            // 작목별로 그룹핑하고 정렬
            const cropIncomes = cropIncomeData
                .map(item => ({
                    crop: item.crop,
                    income: item.value
                }))
                .sort((a, b) => b.income - a.income);
            
            const ctx = document.getElementById('cropIncomeChart').getContext('2d');
            if (charts['cropIncomeChart']) charts['cropIncomeChart'].destroy();
            
            charts['cropIncomeChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: cropIncomes.map(item => item.crop),
                    datasets: [{
                        label: '소득',
                        data: cropIncomes.map(item => item.income),
                        backgroundColor: ['#10b981', '#06b6d4', '#8b5cf6', '#f59e0b', '#ef4444', '#84cc16'],
                        borderColor: ['#059669', '#0891b2', '#7c3aed', '#d97706', '#dc2626', '#65a30d'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', // 가로 막대로 설정
                    scales: {
                        x: {
                            ticks: {
                                font: { size: 9 },
                                callback: val => '₩' + val.toLocaleString()
                            }
                        },
                        y: {
                            ticks: { font: { size: 9 } }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '소득: ₩' + context.parsed.x.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // 사이드바 토글 함수 (모바일용)
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('expanded');
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            loadCSVFromGitHub();
        });
    </script>
</body>
</html>
