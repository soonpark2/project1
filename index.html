<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2024 소득조사 AMIS 업적현황</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Malgun Gothic', 'Segoe UI', sans-serif;
            background: #f8f9fa;
            font-size: 12px;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
            color: white;
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            border-bottom: 2px solid #1e40af;
        }
        
        .header-left {
            font-weight: bold;
        }
        
        .header-right {
            display: flex;
            gap: 20px;
        }
        
        .container {
            display: flex;
            height: calc(100vh - 50px);
        }
        
        .sidebar {
            width: 250px;
            background: #ffffff;
            border-right: 1px solid #e5e7eb;
            padding: 15px;
            overflow-y: auto;
        }
        
        .main-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .filter-section {
            margin-bottom: 20px;
        }
        
        .filter-title {
            background: #3b82f6;
            color: white;
            padding: 8px 12px;
            font-weight: bold;
            font-size: 13px;
            border-radius: 4px 4px 0 0;
        }
        
        .filter-content {
            border: 1px solid #e5e7eb;
            border-top: none;
            background: white;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .filter-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            font-size: 12px;
            transition: background 0.2s;
        }
        
        .filter-item:hover {
            background: #f3f4f6;
        }
        
        .filter-item.active {
            background: #dbeafe;
            color: #1e40af;
            font-weight: bold;
        }
        
        .year-buttons {
            display: flex;
            gap: 5px;
            padding: 10px;
            background: white;
            border: 1px solid #e5e7eb;
            border-top: none;
        }
        
        .year-btn {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            background: white;
            cursor: pointer;
            font-size: 11px;
            border-radius: 3px;
            transition: all 0.2s;
        }
        
        .year-btn:hover {
            background: #f3f4f6;
        }
        
        .year-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto auto;
            gap: 15px;
            height: 100%;
        }
        
        .chart-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-size: 14px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .income-summary {
            grid-column: 1 / 3;
            display: flex;
            gap: 15px;
        }
        
        .summary-box {
            flex: 1;
            text-align: center;
            padding: 20px;
            border-radius: 8px;
        }
        
        .summary-box.income {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border: 2px solid #3b82f6;
        }
        
        .summary-box.rate {
            background: linear-gradient(135deg, #fef3c7, #fed7aa);
            border: 2px solid #f59e0b;
        }
        
        .summary-value {
            font-size: 28px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 5px;
        }
        
        .summary-label {
            font-size: 14px;
            color: #6b7280;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .detailed-table {
            grid-column: 1 / 3;
        }
        
        .table-wrapper {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        th {
            background: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
            padding: 10px 8px;
            text-align: left;
            font-weight: bold;
            color: #374151;
            position: sticky;
            top: 0;
        }
        
        td {
            padding: 8px;
            border-bottom: 1px solid #f3f4f6;
            color: #1f2937;
        }
        
        tr:hover {
            background: #f9fafb;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #6b7280;
        }
        
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .income-summary {
                grid-column: 1;
            }
            
            .detailed-table {
                grid-column: 1;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
            }
            
            .income-summary {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">2024 소득조사 AMIS 업적현황 &nbsp;&nbsp; 2025-07-25일 기준</div>
        <div class="header-right">
            <span>업적현황</span>
            <span>작목군별</span>
            <span>시군별</span>
            <span>종합분석</span>
            <span>소득조사</span>
            <span>업브로드</span>
            <span>관리지표분석</span>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="filter-section">
                <div class="filter-title">지역구분</div>
                <div class="filter-content" id="regionFilter">
                    <div class="filter-item active" data-region="전국">전국</div>
                    <div class="filter-item" data-region="강원">강원</div>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-title">작목</div>
                <div class="filter-content" id="cropGroupFilter">
                    <div class="filter-item active" data-crop-group="">전체</div>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-title">작목상세</div>
                <div class="filter-content" id="cropFilter">
                    <div class="filter-item active" data-crop="">전체</div>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-title">년</div>
                <div class="year-buttons" id="yearFilter">
                    <div class="year-btn active" data-year="">전체</div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="charts-grid">
                <div class="chart-card income-summary">
                    <div class="chart-title">2023년 전국 농사소득지배수</div>
                    <div style="display: flex; gap: 20px;">
                        <div class="summary-box income">
                            <div class="summary-label">소득</div>
                            <div class="summary-value" id="totalIncome">₩0</div>
                            <div class="summary-label">총수량</div>
                        </div>
                        <div class="summary-box rate">
                            <div class="summary-label">소득률</div>
                            <div class="summary-value" id="totalRate">0%</div>
                        </div>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-title">홍수입</div>
                    <div class="chart-container">
                        <canvas id="incomeChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-title">경작비</div>
                    <div class="chart-container">
                        <canvas id="costChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-title">경영비</div>
                    <div class="chart-container">
                        <canvas id="managementChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-title">생산량</div>
                    <div class="chart-container">
                        <canvas id="productionChart"></canvas>
                    </div>
                </div>

                <div class="chart-card detailed-table">
                    <div class="chart-title">2023년 전국 농사제소 작목별 소득</div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>작목군</th>
                                    <th>작목</th>
                                    <th>연도</th>
                                    <th>소득</th>
                                    <th>소득률(%)</th>
                                </tr>
                            </thead>
                            <tbody id="detailTableBody">
                                <tr><td colspan="5" class="loading">데이터를 불러오는 중...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let csvData = [];
        let filteredData = [];
        let currentFilters = {
            region: '전국',
            cropGroup: '',
            crop: '',
            year: ''
        };
        let charts = {};

        // GitHub에서 CSV 파일 불러오기
        async function loadCSVFromGitHub() {
            try {
                const csvUrl = 'https://raw.githubusercontent.com/soonpark2/project1/main/DB.csv';
                const response = await fetch(csvUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                parseCSV(csvText);
            } catch (error) {
                console.error('CSV 파일 로드 오류:', error);
                showError(`GitHub에서 CSV 파일을 불러올 수 없습니다: ${error.message}`);
                loadTestData();
            }
        }

        // 테스트 데이터 (백업용)
        function loadTestData() {
            const testData = `지역구분,년,작목군,작목,구분,값
전국,2021,과일,사과,소득,4000000
전국,2021,과일,사과,소득률,15.5
전국,2022,과일,사과,소득,4500000
전국,2022,과일,사과,소득률,17.2
전국,2023,과일,사과,소득,5000000
전국,2023,과일,사과,소득률,18.8
전국,2021,과일,배,소득,3200000
전국,2021,과일,배,소득률,12.8
전국,2022,과일,배,소득,3600000
전국,2022,과일,배,소득률,14.1
전국,2023,과일,배,소득,4000000
전국,2023,과일,배,소득률,15.3
전국,2021,채소,배추,소득,2800000
전국,2021,채소,배추,소득률,11.2
전국,2022,채소,배추,소득,2900000
전국,2022,채소,배추,소득률,11.8
전국,2023,채소,배추,소득,3000000
전국,2023,채소,배추,소득률,12.5
전국,2021,채소,감자,소득,2200000
전국,2021,채소,감자,소득률,18.3
전국,2022,채소,감자,소득,2350000
전국,2022,채소,감자,소득률,19.1
전국,2023,채소,감자,소득,2500000
전국,2023,채소,감자,소득률,19.8
강원,2021,과일,사과,소득,800000
강원,2021,과일,사과,소득률,14.2
강원,2022,과일,사과,소득,900000
강원,2022,과일,사과,소득률,15.8
강원,2023,과일,사과,소득,1000000
강원,2023,과일,사과,소득률,16.5
강원,2021,채소,감자,소득,2200000
강원,2021,채소,감자,소득률,18.3
강원,2022,채소,감자,소득,2350000
강원,2022,채소,감자,소득률,19.1
강원,2023,채소,감자,소득,2500000
강원,2023,채소,감자,소득률,19.8`;
            
            parseCSV(testData);
        }

        function showError(message) {
            const tableBody = document.getElementById('detailTableBody');
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: #ef4444;">${message}</td></tr>`;
        }

        function parseCSV(csvText) {
            Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    csvData = results.data.map(row => ({
                        region: (row['지역구분'] || '').trim(),
                        year: (row['년'] || '').trim(),
                        cropGroup: (row['작목군'] || '').trim(),
                        crop: (row['작목'] || '').trim(),
                        category: (row['구분'] || '').trim(),
                        value: parseFloat((row['값'] || '0').toString().replace(/,/g, '')) || 0
                    })).filter(row => row.region && row.cropGroup);
                    
                    if (csvData.length > 0) {
                        initializeFilters();
                        updateDisplay();
                    }
                }
            });
        }

        function initializeFilters() {
            // 작목군 필터 초기화
            const cropGroups = [...new Set(csvData.map(item => item.cropGroup))].sort();
            const cropGroupFilter = document.getElementById('cropGroupFilter');
            cropGroupFilter.innerHTML = '<div class="filter-item active" data-crop-group="">전체</div>';
            cropGroups.forEach(group => {
                cropGroupFilter.innerHTML += `<div class="filter-item" data-crop-group="${group}">${group}</div>`;
            });

            // 연도 필터 초기화
            const years = [...new Set(csvData.map(item => item.year))].sort();
            const yearFilter = document.getElementById('yearFilter');
            yearFilter.innerHTML = '<div class="year-btn active" data-year="">전체</div>';
            years.forEach(year => {
                yearFilter.innerHTML += `<div class="year-btn" data-year="${year}">${year}</div>`;
            });

            updateCrops();
            attachFilterEvents();
        }

        function updateCrops() {
            let filtered = csvData.filter(item => item.region === currentFilters.region);
            if (currentFilters.cropGroup) {
                filtered = filtered.filter(item => item.cropGroup === currentFilters.cropGroup);
            }
            
            const crops = [...new Set(filtered.map(item => item.crop))].sort();
            const cropFilter = document.getElementById('cropFilter');
            cropFilter.innerHTML = '<div class="filter-item active" data-crop="">전체</div>';
            crops.forEach(crop => {
                cropFilter.innerHTML += `<div class="filter-item" data-crop="${crop}">${crop}</div>`;
            });
        }

        function attachFilterEvents() {
            // 지역 필터
            document.querySelectorAll('#regionFilter .filter-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('#regionFilter .filter-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    currentFilters.region = this.dataset.region;
                    updateCrops();
                    updateDisplay();
                });
            });

            // 작목군 필터
            document.addEventListener('click', function(e) {
                if (e.target.matches('#cropGroupFilter .filter-item')) {
                    document.querySelectorAll('#cropGroupFilter .filter-item').forEach(i => i.classList.remove('active'));
                    e.target.classList.add('active');
                    currentFilters.cropGroup = e.target.dataset.cropGroup;
                    currentFilters.crop = '';
                    updateCrops();
                    updateDisplay();
                }
            });

            // 작목 필터
            document.addEventListener('click', function(e) {
                if (e.target.matches('#cropFilter .filter-item')) {
                    document.querySelectorAll('#cropFilter .filter-item').forEach(i => i.classList.remove('active'));
                    e.target.classList.add('active');
                    currentFilters.crop = e.target.dataset.crop;
                    updateDisplay();
                }
            });

            // 연도 필터
            document.addEventListener('click', function(e) {
                if (e.target.matches('#yearFilter .year-btn')) {
                    document.querySelectorAll('#yearFilter .year-btn').forEach(i => i.classList.remove('active'));
                    e.target.classList.add('active');
                    currentFilters.year = e.target.dataset.year;
                    updateDisplay();
                }
            });
        }

        function filterData() {
            filteredData = csvData.filter(item => {
                return item.region === currentFilters.region &&
                       (!currentFilters.cropGroup || item.cropGroup === currentFilters.cropGroup) &&
                       (!currentFilters.crop || item.crop === currentFilters.crop) &&
                       (!currentFilters.year || item.year === currentFilters.year);
            });
        }

        function updateSummary() {
            const totalIncome = filteredData.filter(item => item.category === '소득')
                                          .reduce((sum, item) => sum + item.value, 0);
            const avgRate = filteredData.filter(item => item.category === '소득률')
                                      .reduce((sum, item, _, arr) => sum + item.value / arr.length, 0);

            document.getElementById('totalIncome').textContent = `₩${totalIncome.toLocaleString()}`;
            document.getElementById('totalRate').textContent = `${avgRate.toFixed(1)}%`;
        }

        function updateTable() {
            const tableBody = document.getElementById('detailTableBody');
            
            if (filteredData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6b7280;">데이터가 없습니다.</td></tr>';
                return;
            }

            // 데이터 그룹화
            const grouped = {};
            filteredData.forEach(item => {
                const key = `${item.cropGroup}-${item.crop}-${item.year}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        cropGroup: item.cropGroup,
                        crop: item.crop,
                        year: item.year,
                        income: 0,
                        rate: 0
                    };
                }
                if (item.category === '소득') grouped[key].income = item.value;
                if (item.category === '소득률') grouped[key].rate = item.value;
            });

            let html = '';
            Object.values(grouped).forEach(item => {
                html += `
                    <tr>
                        <td>${item.cropGroup}</td>
                        <td>${item.crop}</td>
                        <td>${item.year}년</td>
                        <td>${item.income.toLocaleString()}</td>
                        <td>${item.rate.toFixed(1)}%</td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html;
        }

        function createChart(canvasId, data, label, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }

            charts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: label,
                        data: data.values,
                        borderColor: color,
                        backgroundColor: color + '20',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 10 } }
                        },
                        y: {
                            grid: { color: '#f3f4f6' },
                            ticks: { 
                                font: { size: 10 },
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateCharts() {
            // 연도별 소득 데이터 준비
            const yearlyIncome = {};
            filteredData.filter(item => item.category === '소득').forEach(item => {
                if (!yearlyIncome[item.year]) yearlyIncome[item.year] = 0;
                yearlyIncome[item.year] += item.value;
            });

            const years = Object.keys(yearlyIncome).sort();
            const incomeValues = years.map(year => yearlyIncome[year]);

            const chartData = {
                labels: years.map(year => year + '년'),
                values: incomeValues
            };

            // 각 차트 업데이트 (임시로 같은 데이터 사용)
            createChart('incomeChart', chartData, '소득', '#3b82f6');
            createChart('costChart', chartData, '경작비', '#ef4444');
            createChart('managementChart', chartData, '경영비', '#f59e0b');
            createChart('productionChart', chartData, '생산량', '#10b981');
        }

        function updateDisplay() {
            filterData();
            updateSummary();
            updateTable();
            updateCharts();
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            loadCSVFromGitHub();
        });
    </script>
</body>
</html>
